<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <title>Video Conferencing using RTCMultiConnection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

    <link rel="stylesheet" href="/vendor/muaz-khan/getMediaElement.css">

    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/vendor/muaz-khan/DetectRTC.js"></script>
    <script>
        // add this script before loading "RTCMultiConnection.min.js"
        window.getExternalIceServers = true;
    </script>
    <script type="text/javascript" src="/vendor/muaz-khan/RTCMultiConnection.min.js"></script>
    <script type="text/javascript" src="/vendor/muaz-khan/RecordRTC.js"></script>
</head>
<body>
    <div>
        <input id="room-id-txt" type="text" placeholder="Room ID">
    </div>
    <button id="btn-open-or-join">Open or Join</button>
    <button id="btn-leave">Leave</button>
    <hr>
    <div id="video-container" style="width: 100%; height: 90%;"></div>
    <script type="text/javascript">
        var connection = new RTCMultiConnection();
        //connection.socketURL = '/';
        connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
        connection.session = {audio: true, video: true};
        connection.sdpConstraints.mandatory = {OfferToReceiveAudio: true, OfferToReceiveVideo: true};
        var videosContainer = document.getElementById('video-container');
        document.getElementById('room-id-txt').value = 'room1';  //;(Math.random()*100).toString().replace('.', '');
        var roomid = null;
        document.getElementById('btn-open-or-join').onclick = function(){
            roomid = document.getElementById('room-id-txt').value;
            this.disable = true;
            connection.openOrJoin(roomid);
        };

        document.getElementById('btn-leave').onclick = function(){
            connection.disconnect();
        };

        connection.onstream = function (e) {
            var mediaElement = getMediaElement(e.mediaElement, {
                width: (videosContainer.clientWidth / 2) - 50,
                buttons: ['mute-audio', 'mute-video', 'record-audio', 'record-video', 'full-screen', 'volume-slider', 'stop', 'take-snapshot'],
                toggle: e.type == 'local' ? ['mute-audio'] : [],
                onMuted: function(type) {
                    // www.RTCMultiConnection.org/docs/mute/
                    connection.streams[e.streamid].mute({
                        audio: type == 'audio',
                        video: type == 'video'
                    });
                },
                onUnMuted: function(type) {
                    // www.RTCMultiConnection.org/docs/unmute/
                    connection.streams[e.streamid].unmute({
                        audio: type == 'audio',
                        video: type == 'video'
                    });
                },
                onRecordingStarted: function(type) {
                    // www.RTCMultiConnection.org/docs/startRecording/
                    connection.streams[e.streamid].startRecording({
                        audio: type == 'audio',
                        video: type == 'video'
                    });
                },
                onRecordingStopped: function(type) {
                    // www.RTCMultiConnection.org/docs/stopRecording/
                    connection.streams[e.streamid].stopRecording(function(blob) {
                        if (blob.audio) connection.saveToDisk(blob.audio);
                        else if (blob.video) connection.saveToDisk(blob.audio);
                        else connection.saveToDisk(blob);
                    }, type);
                },
                onStopped: function() {
                    connection.peers[e.userid].drop();
                },
                onTakeSnapshot: function() {
                    if (!e.stream.getVideoTracks().length) return;

                    // www.RTCMultiConnection.org/docs/takeSnapshot/
                    connection.takeSnapshot(e.userid, function(snapshot) {
                        // on taking snapshot!
                    });
                }
            });
            videosContainer.appendChild(mediaElement);
        };

        connection.onstreamended = function(e) {
            destroyChildren(videosContainer);
        };

         function destroyChildren (node){
            if (!node) return;
            node.innerHTML = '';
            while (node.firstChild)
                node.removeChild(node.firstChild);
        }

    </script>

</body>
</html>