var Ajax={getXMLHttp:function(){var n;try{n=new XMLHttpRequest}catch(e){try{n=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return alert("Your browser does not support AJAX!"),!1}}}return n},sendRequest:function(e,n,t,o){var i=Ajax.getXMLHttp();("GET"==e||"get"==e&&null!=t)&&(n+="?"+t),i.open(e,n,!0),i.onreadystatechange=function(){4==i.readyState&&(200==i.status?o(JSON.parse(i.responseText)):o(null))},"POST"==e||"post"==e?(i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send(t)):i.send(null)}},A={nicname:null,selected_user:null,init:function(){A.socket=Socket,A.io=io,A.socket.init(A),A.files=F,A.files.init(A),A.filesp2p=Fp2p,A.filesp2p.init(A),A.wrtc=WRTC,A.wrtc.init(A),A.setEventHandlers(),A.iface=I,A.iface.init(A),A.au=AU,A.au.init(A)},setEventHandlers:function(){A.socket.setEventHandler("connect",A.connect),A.socket.setEventHandler("disconnect",A.disconnect),A.socket.setEventHandler("new_message",A.newMessage),A.socket.setEventHandler("new_user",A.newUser),A.socket.setEventHandler("user_disconnected",A.userLost),A.socket.setEventHandler("users_online",A.refreshUsersOnline),A.socket.setEventHandler("last_messages",A.lastMessages),A.socket.setEventHandler("have_file",A.haveFile),A.socket.setEventHandler("file_accepted",A.fileAccepted),A.socket.setEventHandler("you_files",A.incomingFiles),A.socket.setEventHandler("wrtc_message",A.gotWRTCMessage),A.socket.setEventHandler("upload_error",A.uploadError)},connect:function(){A.socket.send("user_connect",{nicname:A.nicname})},disconnect:function(){window.location.reload(!0)},sendUserMessage:function(e){var n;null!=A.selected_user&&(null!=A.wrtc.chat_datachannel&&A.selected_user==A.wrtc.selected_user?(n={created:(new Date).getTime(),from:WRTC.app.nicname,to:WRTC.selected_user,message:e},A.iface.addMessage(n),A.wrtc.chat_datachannel.send(e),console.log("send message p2p")):(A.socket.send("user_message",{message:e,to:A.selected_user}),console.log("send message across server")))},newMessage:function(e){A.iface.addMessage(e.message)},newUser:function(e){e="New user "+e.user+" was connected!";A.serverMessage(e)},userLost:function(e){var n="User "+e.user+" was disconnected!";A.wrtc.selected_user===e.user&&A.wrtc.hangup(),A.serverMessage(n)},refreshUsersOnline:function(e){console.log(e.users_online),console.log(e.ice),e.ice&&(A.wrtc.pc_config=JSON.parse(window.atob(e.ice))),A.iface.refreshUsersOnline(e.users_online)},setSelectedUser:function(e){A.selected_user=e,window.localStorage&&window.localStorage.setItem("selected_user",e)},serverMessage:function(e){A.iface.hideNote(),A.iface.showNote(e)},requestMessagesHistory:function(){A.socket.send("message_history",{user1:A.nicname,user2:A.selected_user,lefttime:A.iface.HISTORY_LEFTTIME})},lastMessages:function(e){A.iface.refreshMessages(e.messages),A.requestFiles()},sendFile:function(e,n){null!=A.wrtc.file_datachannel&&A.selected_user==A.wrtc.selected_user?(console.log("send file p2p"),Fp2p.sendFile(e,A.wrtc.file_datachannel,n)):(console.log("send file to server"),F.sendFile(e,"/upload",A.selected_user,A.nicname,n))},haveFile:function(e){e=["User ",e.from," send for you file ",e.fname," size: ",e.fsize].join("");A.iface.showNote(e),A.requestFiles()},fileAccepted:function(e){A.files.fileAccepted(e.fname)},uploadError:function(e){A.files.uploadError(e.fname)},requestFiles:function(){A.socket.send("request_files")},incomingFiles:function(e){A.iface.refreshFilesLinks(e)},gotWRTCMessage:function(e){A.wrtc.gotMessage(e)}},AU={};function getCookie(e){e=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0}function setCookie(e,n,t){var o,i=(t=t||{}).expires;"number"==typeof i&&i&&((o=new Date).setTime(o.getTime()+1e3*i),i=t.expires=o),i&&i.toUTCString&&(t.expires=i.toUTCString());var s,a=e+"="+(n=encodeURIComponent(n));for(s in t){a+="; "+s;var r=t[s];!0!==r&&(a+="="+r)}document.cookie=a}function deleteCookie(e){setCookie(e,"",{expires:-1})}function sleep(n){return new Promise(e=>setTimeout(e,n))}AU.app=null,AU.init=function(e){AU.app=e,AU.audioCtx,AU.audioSource=null;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,AU.audioCtx=new AudioContext}catch(e){console.log("Web Audio API is not supported in this browser")}AU.buffers={},AU.loadSound("/sounds/"+AU.app.iface.call_sound)},AU.loadSound=function(n,e){var t=new XMLHttpRequest;t.open("GET",n,!0),t.responseType="arraybuffer",t.onload=function(){AU.audioCtx.decodeAudioData(t.response,function(e){AU.buffers[n.split("/").pop()]=e},function(e){console.log(e)})},t.send()},AU.playSound=function(e){e=AU.buffers[e];AU.audioSource=AU.audioCtx.createBufferSource(),AU.audioSource.buffer=e,AU.audioSource.loop=!0,AU.audioSource.connect(AU.audioCtx.destination),AU.audioSource.start(0)},AU.stopSound=function(){null!=AU.audioSource&&(AU.audioSource.stop(0),AU.audioSource=null)},window.onload=function(){!function(){var e={},n=/([^&=]+)=?([^&]*)/g;function t(e){return decodeURIComponent(e.replace(/\+/g," "))}for(var o,i=window.location.search;o=n.exec(i.substring(1));)e[t(o[1])]=t(o[2]);window.params=e}(),$(function(){window.diagMess=$("#dialog-message").dialog({modal:!0,autoOpen:!1})}),function(){var i=new RTCMultiConnection;i.socketURL="/rtcmulticonnection/",i.autoCloseEntireSession=!0,i.session={audio:!0,video:!0,data:!0},i.sdpConstraints.mandatory={OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},i.chunkSize=16e3,i.enableFileSharing=!0,i.autoSaveToDisk=!1;var s,e,o=document.getElementById("videos"),n=document.getElementById("btn-open-or-join"),t=document.getElementById("btn-leave"),a=document.getElementById("room-id-txt"),r=document.getElementById("user-name"),c={},l=document.getElementById("onUserStatusChanged"),d=document.getElementById("messages-list"),u=(document.getElementById("input-message"),document.getElementById("btn-send-message")),p=document.getElementById("btn-select-file"),f=document.getElementById("btn-share-screen"),m={},g=null,h=null,w=null,C={video:!0},v=new CanvasDesigner;v.widgetHtmlURL="/vendor/canvas-designer/widget.html",v.widgetJsURL="/vendor/canvas-designer/widget.min.js",n.onclick=function(){e=a.value,w=r.value,i.extra.userFullName=w,a.style.display="none",r.style.display="none",i.openOrJoin(e,function(){t.style.display="inline-block",n.style.display="none"})},t.onclick=function(){console.log("leave"),i.closeEntireSession(function(){_("Entire session has been closed.")}),window.location.reload()},u.onclick=function(){var e,n=$(".emojionearea-editor").html();$(".emojionearea-editor").html(""),n&&n.replace(/ /g,"").length&&i.peers.getLength()&&(e=i.userid+i.token(),y(n,e),i.send({chatMessage:n,checkmark_id:e}),i.send({typing:!1}))},p.onclick=function(){(new FileSelector).selectSingleFile(function(e){s=e,1<=i.getAllParticipants().length&&(s.userIndex=0,i.send(e,i.getAllParticipants()[s.userIndex]))})},f.onclick=function(){f.style.display="none",navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(C).then(function(e){R(e)},function(e){_("Please make sure to use Edge 17 or higher.")}):navigator.getDisplayMedia?navigator.getDisplayMedia(C).then(function(e){R(e)},function(e){_("Please make sure to use Edge 17 or higher.")}):_("getDisplayMedia API is not available in this browser.")},i.onstream=function(e){var n;console.log("e:",e),console.log("streamid:",e.streamid),console.log("whatis:",i.streamEvents[e.streamid]),console.log("e.userid:",e.userid),console.log("peers:",i.peers),e.stream.isScreen?(I(c[e.userid].media,e.stream),i.onUserStatusChanged(e)):(n=function(t){var e=getMediaElement(t.mediaElement,{title:function(e){if("local"===e.type&&w)return w;var n=e.userid,e=n;i.peers[n]&&i.peers[n].extra.userFullName&&(e=i.peers[n].extra.userFullName);return e}(t),width:o.clientWidth/2-50,buttons:["mute-audio","mute-video","record-audio","record-video","full-screen","volume-slider","stop","take-snapshot"],toggle:"local"==t.type?["full-screen","mute-audio"]:["full-screen"],onMuted:function(e){i.streamEvents[t.streamid].stream.mute({audio:"audio"==e,video:"video"==e})},onUnMuted:function(e){i.streamEvents[t.streamid].stream.unmute({audio:"audio"==e,video:"video"==e})},onRecordingStarted:function(e){i.streamEvents[t.streamid].startRecording({audio:"audio"==e,video:"video"==e})},onRecordingStopped:function(e){i.streamEvents[t.streamid].stopRecording(function(e){e.audio||e.video?i.saveToDisk(e.audio):i.saveToDisk(e)},e)},onStopped:function(){i.peers[t.userid].drop()},onTakeSnapshot:function(){var o,e,n;t.stream.getVideoTracks().length&&(o=t.userid,"function"==typeof ImageCapture&&(e=t.stream.getVideoTracks()[0],(n=new ImageCapture(e)).takePhoto().then(function(e){e=URL.createObjectURL(e);window.open(e)}).catch(function(e){n.grabFrame().then(function(e){var n=document.createElement("canvas"),t=c[o].media;n.width=t.videoWidth||t.clientWidth,n.height=t.videoHeight||t.clientHeight,n.getContext("2d").drawImage(e,0,0,e.width,e.height),n.toBlob(function(e){e=URL.createObjectURL(e);window.open(e)})}).catch(function(e){_(e.toString())})})))}});return e.id=t.streamid,e}(e),"local"===e.type&&(g=e.stream,h=e.userid,n.type="local"),c[e.userid]=n,o.appendChild(n),i.onUserStatusChanged(event))},i.onstreamended=function(e){e=document.getElementById(e.streamid);e?e.parentNode.removeChild(e):e&&(e.srcObject=null,e.style.display="none")},i.onmessage=function(e){var n;!0!==e.data.typing?!1!==e.data.typing?e.data.chatMessage?y(e):"received"!==e.data.checkmark?e.data:(n=document.getElementById(e.data.checkmark_id))&&(n.style.display="inline"):$("#key-press").hide().find("span").html(""):$("#key-press").show().find("span").html(e.extra.userFullName+" is typing")},i.onUserStatusChanged=function(e){var n=[];i.getAllParticipants().forEach(function(e){console.log("onUserStatusChanged pid:",e),n.push(S(e)),console.log("onUserStatusChanged pid:",n)}),n=n.length?[i.extra.userFullName||"You"].concat(n):["Only You"];l.innerHTML="<b>Active users:</b> "+n.join(", ")},i.onopen=function(e){i.onUserStatusChanged(e),u.disabled=!1,p.style.display="inline-block",f.style.display="inline-block"},i.onFileEnd=function(e){var n=function(e){var n=e.url||URL.createObjectURL(e),t='<a href="'+n+'" target="_blank" download="'+e.name+'">Download: <b>'+e.name+"</b></a>";e.name.match(/\.jpg|\.png|\.jpeg|\.gif/gi)?t+='<br><img crossOrigin="anonymous" src="'+n+'">':e.name.match(/\.wav|\.mp3/gi)?t+='<br><audio src="'+n+'" controls></audio>':e.name.match(/\.pdf|\.js|\.txt|\.sh/gi)&&(t+='<iframe class="inline-iframe" src="'+n+'"></iframe></a>');return t}(e),t=m[e.uuid].div;{var o;e.userid===i.userid?(t.innerHTML="<b>You:</b><br>"+n,t.style.background="#cbffcb",s?(s.userIndex++,(o=i.getAllParticipants()[s.userIndex])?i.send(s,o):s=null):s=null):t.innerHTML="<b>"+S(e.userid)+":</b><br>"+n}},i.onFileProgress=function(e,n){var t=m[e.uuid];t.progress.value=e.currentPosition||e.maxChunks||t.progress.max,function(e,n){-1!=e.position&&(e=+e.position.toFixed(2).split(".")[1]||100,n.innerHTML=e+"%")}(t.progress,t.label)},i.onFileStart=function(e){var n=document.createElement("li");{var t;n.className="message",e.userid===i.userid?(t=e.remoteUserId,i.peersBackup[e.remoteUserId]&&(t=i.peersBackup[e.remoteUserId].extra.userFullName),n.innerHTML="<b>You (to: "+t+"):</b><br><label>0%</label> <progress></progress>",n.style.background="#cbffcb"):n.innerHTML="<b>"+S(e.userid)+":</b><br><label>0%</label> <progress></progress>"}n.title=e.name,d.appendChild(n),m[e.uuid]={div:n,progress:n.querySelector("progress"),label:n.querySelector("label")},m[e.uuid].progress.max=e.maxChunks,d.scrollTop=d.clientHeight,d.scrollTop=d.scrollHeight-d.scrollTop},i.onclose=i.onerror=i.onleave=function(e){i.onUserStatusChanged(e)};var T,v=io.connect(window.location.host+"/");function S(e){return i.peers[e]&&i.peers[e].extra.userFullName?i.peers[e].extra.userFullName:e}function y(e,n){var t=document.createElement("li");t.className="message",console.log("appendChatMessage event:",e),e.data?(t.innerHTML="<b>"+(e.extra.userFullName||e.userid)+":</b><br>"+e.data.chatMessage,e.data.checkmark_id&&i.send({checkmark:"received",checkmark_id:e.data.checkmark_id})):(t.innerHTML='<b>You:</b> <img class="checkmark" id="'+n+'" title="Received" src="/img/checkmark.png"><br>'+e,t.style.background="#cbffcb"),d.appendChild(t),d.scrollTop=d.clientHeight,d.scrollTop=d.scrollHeight-d.scrollTop}v.on("ice",function(e){e.ice&&(i.iceServers=JSON.parse(window.atob(e.ice)).iceServers)}),v.emit("get_ice",{});var b=0;function k(t,o){t&&("ended"!==t.readyState?i.getAllParticipants().forEach(function(e){var n,e=i.peers[e].peer;e.getSenders&&(n=t,e.getSenders().forEach(function(e){e&&e.track&&(o?n&&e.track.id===o&&(e.replaceTrack(n),n=null):e.track.id!=g.getTracks()[0].id&&"video"===e.track.kind&&n&&(e.replaceTrack(n),n=null))}))}):_('Can not replace an "ended" track. track.readyState: '+t.readyState))}function R(e){e.isScreen=!0,e.streamid=e.id,e.type="local",console.log("replaceScreenTrack stream: ",e),i.onstream({stream:e,type:"local",streamid:e.id,userid:h});var n,t,o=e.getTracks()[0].id;t=function(){k(g.getVideoTracks()[0],o),f.style.display="inline-block",I(function(){for(var e in c)if("local"===c[e].type)return c[e];return null}().media,g)},(n=e).addEventListener("ended",function(){t(),t=function(){}},!1),n.addEventListener("inactive",function(){t(),t=function(){}},!1),n.getTracks().forEach(function(e){e.addEventListener("ended",function(){t(),t=function(){}},!1),e.addEventListener("inactive",function(){t(),t=function(){}},!1)}),e.getTracks().forEach(function(e){"video"===e.kind&&"live"===e.readyState&&k(e)})}function I(e,n){console.log("attachStream",n),window.URL||window.webkitURL?e.srcObject=n:e.src=n}function _(e,n,t){$("#dialog-message").attr({title:e}),$("#dialog-message p").html("<p>"+n+"</p>"),diagMess.dialog("option","buttons",{Ok:function(){$(this).dialog("close"),t&&t()}}),diagMess.dialog("open")}$("#input-message").emojioneArea({pickerPosition:"top",filtersPosition:"bottom",tones:!1,autocomplete:!0,inline:!0,hidePickerOnBlur:!0,events:{focus:function(){$(".emojionearea-category").unbind("click").bind("click",function(){$(".emojionearea-button-close").click()})},keyup:function(e){var n=$(".emojionearea-editor").html();n&&n.replace(/ /g,"").length||i.send({typing:!1}),clearTimeout(T),++b%3==0&&i.send({typing:!0}),T=setTimeout(function(){i.send({typing:!1})},1200)},blur:function(){i.send({typing:!1})}}}),window.onkeyup=function(e){13==(e.keyCode||e.which)&&$("#btn-send-message").click()}}()},F={app:null,FILE_API:!1,choosen_files:[],init:function(e){F.app=e,window.File&&window.FileReader&&window.FileList&&window.Blob?(F.FILE_API=!0,console.log("File API is supported")):(F.FILE_API=!1,console.log("File API is not supported"))},handlerFileSelect:function(e){e=e.target.files;F.choosen_files=Array.from(e),F.app.iface.fillFilesList(F.choosen_files)},readFile:function(n,t){var e=new FileReader;e.onload=function(e){t(n,e.target.result)},e.readAsBinaryString(n)},fileAccepted:function(e){for(var n in F.choosen_files)F.choosen_files[n].name==e&&F.choosen_files.splice(n,1);0==F.choosen_files.length&&(F.app.iface.fillFilesList(F.choosen_files),F.app.iface.files_input.value=null)},uploadError:function(e){for(var n in F.choosen_files)F.choosen_files[n].name==e&&F.choosen_files.splice(n,1);F.app.iface.fillFilesList(F.choosen_files),dialogMessage("Chat1","Ошибка при отправке файла "+e)},deleteFile:function(e){var n=this.id;Ajax.sendRequest("GET",n,null,A.requestFiles)},sendFile:function(e,n,t,o,i){var s=new FormData;s.append("myfile",e,e.name),s.append("to",t),s.append("from",o),$.ajax({url:n,type:"POST",data:s,processData:!1,contentType:!1,success:function(e){console.log("upload successful!\n"+e)},xhr:function(){var e=new XMLHttpRequest;return e.upload.addEventListener("progress",function(e){e.lengthComputable&&(e=e.loaded/e.total,e=parseInt(100*e),i.innerText=e+"%",i.textContent=e+"%",i.style.width=e+"%",100===e&&(i.innerText="Done",i.textContent="Done",i.style.width="100%"))},!1),e}})}};var I={app:null,messages:[],MAX_MESSAGES_LEN:1e3,NOTE_TIME:3e4,timeout:null,HISTORY_LEFTTIME:48,CHAT_ENABLE:!(Fp2p={BYTES_PER_CHUNK:12288,BUFFERED_AMOUNT_LIMIT:1e7,app:null,p2pConnection:null,incomingFiles:{},init:function(e){Fp2p.app=e},getFileObject:function(e,n){return{file:e,fileReader:new FileReader,p2pConnection:n,currentChunk:0,uuid:UUID4()}},sendFile:function(e,n,t){var o=Fp2p.getFileObject(e,n);o.fileReader.onload=function(){Fp2p.sendNextChunk(o)},o.progressbar=t,Fp2p.startUpload(o)},startDownload:function(e){"start"===(e=JSON.parse(e.toString())).type?(Fp2p.incomingFiles[e.uuid]={},Fp2p.incomingFiles[e.uuid].incomingFileInfo=e,Fp2p.incomingFiles[e.uuid].incomingFileData=[],Fp2p.incomingFiles[e.uuid].bytesReceived=0,Fp2p.incomingFiles[e.uuid].downloadInProgress=!0,console.log("incoming file <b>"+Fp2p.incomingFiles[e.uuid].incomingFileInfo.fileName+"</b> of "+Fp2p.incomingFiles[e.uuid].incomingFileInfo.fileSize+" bytes")):"end"===e.type&&Fp2p.endDownload(e.uuid)},progressDownload:function(e){var n,t,o;console.log(e),e.byteLength?(n=e.slice(36),t=(new TextDecoder).decode(new Int8Array(e.slice(0,36))),o=n.byteLength||n.size,Fp2p.incomingFiles[t].bytesReceived+=o,Fp2p.incomingFiles[t].incomingFileData.push(n),console.log(Fp2p.incomingFiles[t].bytesReceived),console.log(Fp2p.incomingFiles[t].incomingFileInfo.fileSize),console.log("progress: "+(Fp2p.incomingFiles[t].bytesReceived/Fp2p.incomingFiles[t].incomingFileInfo.fileSize*100).toFixed(2)+"%"),Fp2p.incomingFiles[t].bytesReceived===Fp2p.incomingFiles[t].incomingFileInfo.fileSize&&Fp2p.endDownload(t)):new Response(e).arrayBuffer().then(function(e){Fp2p.progressDownload(e)})},endDownload:function(e){var n,t;void 0!==Fp2p.incomingFiles[e]&&(Fp2p.incomingFiles[e].bytesReceived<Fp2p.incomingFiles[e].incomingFileInfo.fileSize||(Fp2p.incomingFiles[e].downloadInProgress=!1,t=new window.Blob(Fp2p.incomingFiles[e].incomingFileData),(n=document.createElement("a")).innerHTML=Fp2p.incomingFiles[e].incomingFileInfo.fileName,n.href=URL.createObjectURL(t),n.download=Fp2p.incomingFiles[e].incomingFileInfo.fileName,Fp2p.app.iface.appendIncomingFile(n),n.click?n.click():((t=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(t)),delete Fp2p.incomingFiles[e]))},startUpload:function(e){console.log("sending "+e.file.name+" of "+e.file.size+" bytes"),e.currentChunk=0,e.p2pConnection.send(JSON.stringify({fileName:e.file.name,fileSize:e.file.size,uuid:e.uuid,type:"start"})),Fp2p.readNextChunk(e)},readNextChunk:async function(e){var n=Fp2p.BYTES_PER_CHUNK*e.currentChunk,t=Math.min(e.file.size,n+Fp2p.BYTES_PER_CHUNK);e.p2pConnection.bufferedAmount<Fp2p.BUFFERED_AMOUNT_LIMIT?e.fileReader.readAsArrayBuffer(e.file.slice(n,t)):(await sleep(30),Fp2p.readNextChunk(e))},sendNextChunk:function(e){var n=(new TextEncoder).encode(e.uuid),t=new Int8Array(e.fileReader.result),o=new Int8Array(t.length+n.length);o.set(n),o.set(t,n.length),e.p2pConnection.send(o.buffer),e.currentChunk++,Fp2p.BYTES_PER_CHUNK*e.currentChunk<e.file.size?(Fp2p.readNextChunk(e),o=Fp2p.BYTES_PER_CHUNK*e.currentChunk/e.file.size,o=parseInt(100*o),e.progressbar.innerText=o+"%",e.progressbar.textContent=o+"%",e.progressbar.style.width=o+"%"):(e.progressbar.innerText="Done",e.progressbar.textContent="Done",e.progressbar.style.width="100%",e.p2pConnection.send(JSON.stringify({uuid:e.uuid,type:"end"})),Fp2p.app.files.fileAccepted(e.file.name),e=null)}}),call_sound:"call.wav",elements:{messages_block:"messages",note_block:"note",note_text:"note-text",note_close:"note-close",input:"input",send_btn:"send-btn",exit_btn:"exit-btn",nicname:"nicname",clear_btn:"clear-btn",user_for_chat:"user-for-chat",user_for_videochat:"user-for-videochat",list_users_online:"users-online",test:"test",files_list:"files-list",files_input:"files-input",files_wrap:"files-wrap",send_files_btn:"send-files-btn",files_preload:"files-preload",incoming_files:"incoming-files",local_video:"localVideo",video_wrap:"video-wrap",remote_video:"remoteVideo",call_button:"callButton",hangup_button:"hangupButton",cancel_button:"cancel-btn",chat_preload:"chat-preload",screenshare_button:"screenshareButton",video_off_button:"videoOff",video_on_button:"videoOn",audio_off_button:"audioOff",audio_on_button:"audioOn"},init:function(e){I.app=e,I.initElements(),I.setInterfaceHandlers(),I.app.files.FILE_API||(I.files_wrap.innerHTML="<p>You browser does not supported File API</p>"),I.showMessages(),window.localStorage&&(I.app.selected_user=window.localStorage.getItem("selected_user"))},testf:function(){console.log("test")},sendFiles:function(){if(I.CHAT_ENABLE)if(0!=F.choosen_files.length){I.hideElem(I.send_files_btn),I.hideElem(I.files_input);for(var e,n=0;e=F.choosen_files[n];n++){var t=document.createElement("div");t.className="progress";var o=document.createElement("div");o.className="progress-bar",t.appendChild(o),document.getElementById("fl-"+n).appendChild(t),o.className="progress-bar",I.app.sendFile(e,o)}}else I.showNote("No files was been choosed")},fillFilesList:function(e){if(I.showElem(I.send_files_btn),I.showElem(I.files_input),0!=e.length){var n,t=['<ul class="files-list">'];for(n in e)"object"==typeof e[n]&&t.push('<li id="fl-',n,'">',e[n].name,"</li>");t.push("</ul>"),null!=I.files_list&&(I.files_list.innerHTML=t.join(""))}else null!=I.files_list&&(I.files_list.innerHTML="")},refreshFilesLinks:function(e){for(var n=[],t=0;t<e.files.length;t++){var o=e.files[t].origname,i=e.files[t].secret;n.push("<li>"),n.push(['<img id="/file-del/',i,'" title="Delete" class="icon-small delete-file" src="/img/cancel-circle.svg"/>'].join("")),n.push("&nbsp;"),n.push(['<a href="/file/',i,'" title="Download" target="_blank">',o,"</a>"].join("")),n.push("</li>")}I.incoming_files.innerHTML=n.join("");for(var s=document.getElementsByClassName("delete-file"),t=0;t<s.length;t++)s[t].addEventListener("click",F.deleteFile,!1)},appendIncomingFile:function(e){var n=document.querySelector("#incoming-files"),t=document.createElement("img");t.src="/img/cancel-circle.svg",t.className="icon-small delete-file",t.title="Double click to delete";var o=document.createElement("li");o.id=UUID4(),o.appendChild(t),o.appendChild(e),o.ondblclick=function(e){n.removeChild(document.getElementById(this.id))},n.appendChild(o)},clearSelectedFiles:function(){I.files_input.value=null,F.choosen_files=[],I.files_list.innerHTML="",I.fillFilesList(F.choosen_files)},initElements:function(){for(var e in I.elements)I[e]=document.getElementById(I.elements[e]);null!=I.messages_block&&(I.messages_block.scrollTop=9999),null!=I.nicname&&(I.app.nicname=I.nicname.innerHTML)},setInterfaceHandlers:function(){var e,n={note_close:{event:"click",handler:I.hideNote},send_btn:{event:"click",handler:I.btnSendHandler},exit_btn:{event:"click",handler:I.exit},test:{event:"click",handler:I.testf},files_input:{event:"change",handler:F.handlerFileSelect},send_files_btn:{event:"click",handler:I.sendFiles},call_button:{event:"click",handler:I.app.wrtc.call},hangup_button:{event:"click",handler:I.app.wrtc.hangup},cancel_button:{event:"click",handler:I.clearSelectedFiles},screenshare_button:{event:"click",handler:I.app.wrtc.screenShare},video_off_button:{event:"click",handler:I.app.wrtc.videoOff},video_on_button:{event:"click",handler:I.app.wrtc.videoOn},audio_off_button:{event:"click",handler:I.app.wrtc.audioOff},audio_on_button:{event:"click",handler:I.app.wrtc.audioOn}};for(e in n)null!=I[e]&&null!=I[e]&&I[e].addEventListener(n[e].event,n[e].handler,!1);window.onkeypress=I.keyPressHandler},addMessage:function(e){I.messages.push(e),I.messages.length>I.MAX_MESSAGES_LEN&&I.messages.splice(0,I.messages.length-I.MAX_MESSAGES_LEN),window.localStorage.setItem("messages",JSON.stringify(I.messages)),I.showMessages()},btnSendHandler:function(){I.CHAT_ENABLE&&(I.app.sendUserMessage(I.input.value),I.input.value="")},keyPressHandler:function(e){13==e.keyCode&&I.btnSendHandler()},refreshMessages:function(o){for(var e=JSON.parse(window.localStorage.getItem("messages"))||[],i=0;i<o.length;i++)void 0===e.find(function(e,n,t){return!(e.created!=o[i].created||e.from!=o[i].from||e.to!=o[i].to)})&&e.push(o[i]);e.sort(function(e,n){return null===e||null===n?-1:e.created-n.created}),I.messages=e.filter(function(e){return!!e}),window.localStorage.setItem("messages",JSON.stringify(I.messages)),I.showMessages()},requestHistory:function(){null!=I.messages_block&&(I.showElem(I.chat_preload),I.app.requestMessagesHistory())},showMessages:function(){if(null!=I.messages_block){for(var e=['<ul class="messages-list">'],n=0;n<I.messages.length;n++)(I.messages[n].from==I.app.selected_user&&I.messages[n].to==I.app.nicname||I.messages[n].to==I.app.selected_user&&I.messages[n].from==I.app.nicname)&&(e.push('<li><span class="created">['),e.push(I.timestamp2date(I.messages[n].created)),e.push("]</span>"),I.messages[n].from==I.app.nicname?e.push('<span class="author-out">'):e.push('<span class="author-in">'),e.push(I.messages[n].from),e.push('</span>: <span class="text">'),e.push(I.messages[n].message),e.push("</span></li>"));e.push("</ul>"),I.hideElem(I.chat_preload),I.messages_block.innerHTML=e.join("")}},exit:function(){deleteCookie("nicname"),I.reloadPage("/")},reloadPage:function(e){window.location.replace(e)},refreshUsersOnline:function(e){if(null!=I.list_users_online){I.destroyChildren(I.list_users_online),-1==e.indexOf(I.app.selected_user)&&I.app.setSelectedUser(null);for(var n,t=0;t<e.length;t++)e[t]!=I.app.nicname&&((n=document.createElement("li")).id="chat-"+e[t],n.className="user-list",console.log(I.app.selected_user+":"+e[t]),I.app.selected_user==e[t]&&(n.className="user-list selected"),null==I.app.selected_user&&(n.className="user-list selected",I.app.setSelectedUser(e[t])),n.innerHTML=e[t],I.list_users_online.appendChild(n));for(var o=document.getElementsByClassName("user-list"),t=0;t<o.length;t++)o[t].addEventListener("click",I.clickOnUser);null!=I.user_for_chat&&(I.user_for_chat.innerHTML=I.app.selected_user),null!=I.user_for_videochat&&(I.user_for_videochat.innerHTML=I.app.selected_user),null!=I.app.selected_user?I.chat_enable(!0):I.chat_enable(!1),I.requestHistory()}},destroyChildren:function(e){if(e)for(e.innerHTML="";e.firstChild;)e.removeChild(e.firstChild)},selectUser:function(e){console.log(e);for(var n=document.getElementsByClassName("user-list"),t=0;t<n.length;t++)n[t].className="user-list",n[t].id.split("-").pop()==e&&(n[t].className="user-list selected");I.app.setSelectedUser(e),null!=I.user_for_chat&&(I.user_for_chat.innerHTML=I.app.selected_user),null!=I.user_for_videochat&&(I.user_for_videochat.innerHTML=I.app.wrtc.selected_user),I.requestHistory()},clickOnUser:function(e){var n=this.id.split("-").pop();I.selectUser(n)},showNote:function(e){null!=I.note_block&&(I.note_text.innerHTML=e,I.note_block.style.display="block",I.timeout=setTimeout(I.hideNote,I.NOTE_TIME))},hideNote:function(){null!=I.timeout&&(clearTimeout(I.timeout),I.timeout=null),null!=I.note_block&&null!=I.note_text&&(I.note_text.innerHTML="",I.note_block.style.display="none")},timestamp2date:function(e){return new Date(e).toLocaleString()},hideElem:function(e){null!=e&&null!=e&&(e.style.display="none")},showElem:function(e){null!=e&&null!=e&&(e.style.display="block")},chat_enable:function(e){(I.CHAT_ENABLE=e)?I.input.hasAttribute("disabled")&&I.input.removeAttribute("disabled"):I.input.disabled=!0}};UUID4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})},window.onload=function(){Date.now||(Date.now=function(){return(new Date).getTime()}),A.init()};var diagConfirm,diagMess,Socket={};function dialogConfirm(e,n,t,o){$("#dialog-confirm").attr({title:e}),$("#dialog-confirm").html('<p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>'+n+" </p>"),diagConfirm.dialog("option","buttons",{Ok:function(){t(),$(this).dialog("close")},Cancel:function(){o(),$(this).dialog("close")}}),diagConfirm.dialog("open")}function closeDialogConfirm(){diagConfirm&&diagConfirm.dialog("close")}function dialogMessage(e,n,t){$("#dialog-message").attr({title:e}),$("#dialog-message p").html("<p>"+n+"</p>"),diagMess.dialog("option","buttons",{Ok:function(){$(this).dialog("close"),t&&t()}}),diagMess.dialog("open")}function closeDialogMessage(){diagMess&&diagMess.dialog("close")}Socket.url=null,Socket.pathname=null,Socket.socket=null,Socket.hostname=null,Socket.app=null,Socket.init=function(e){Socket.app=e,Socket.url=window.location.host,Socket.pathname=window.location.pathname,Socket.socket=Socket.app.io.connect(Socket.url+Socket.pathname),Socket.hostname=window.location.hostname},Socket.setEventHandler=function(e,n){Socket.socket.on(e,n)},Socket.send=function(e,n){Socket.socket.emit(e,n)},$(function(){$("#accordion").accordion({header:"> div > h3",heightStyle:"fill"}).sortable({axis:"y",handle:"h3",stop:function(e,n){n.item.children("h3").triggerHandler("focusout"),$(this).accordion("refresh")}}),$("#tabs").tabs(),$("#video-wrap .localVideo").draggable({containment:".right",scroll:!1}).resizable(),$("#video-wrap .remoteVideo").draggable({containment:".right",scroll:!1}).resizable(),diagConfirm=$("#dialog-confirm").dialog({resizable:!1,height:"auto",width:400,modal:!0,autoOpen:!1}),diagMess=$("#dialog-message").dialog({modal:!0,autoOpen:!1})});var PeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,IceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,SessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription;navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia;var WRTC={pc_config:null,init:function(e){WRTC.app=e,WRTC.pc=null,WRTC.localStream=null,WRTC.screenStream=null,WRTC.online=!1,WRTC.chat_datachannel=null,WRTC.file_datachannel=null,WRTC.hang_up=!0,WRTC.mediaOptions={audio:!0,video:!0},WRTC.selected_user=null,window.localStorage&&(WRTC.selected_user=window.localStorage.getItem("videochat_user"))},call:function(){console.log(Date.now(),"call","pc_config",WRTC.pc_config),WRTC.hang_up&&(WRTC.setSelectedUser(WRTC.app.selected_user),WRTC.setHangUp(!0),WRTC.sendMessage({type:"intent_call"}),WRTC.app.au.playSound(WRTC.app.iface.call_sound))},beginConnect:function(){WRTC.hang_up||WRTC.getUserMedia(WRTC.gotStreamCaller)},getUserMedia:function(e){console.log(Date.now(),"getUserMedia"),navigator.getUserMedia(WRTC.mediaOptions,e,function(e){WRTC.getUserMedia=function(e){console.log(Date.now(),"getUserMedia"),navigator.getUserMedia({audio:!0,video:!1},e,function(e){console.log(e)})}})},answer:function(){console.log(Date.now(),"answer"),WRTC.getUserMedia(WRTC.gotStreamCalle)},gotStreamCaller:function(e){WRTC.sendMessage({type:"call"}),WRTC.attachStream(document.getElementById("localVideo"),e),WRTC.localStream=e,console.log(Date.now(),"gotStream:",e),WRTC.pc=new PeerConnection(WRTC.pc_config),WRTC.addStreamToRTCPeerConnection(e),WRTC.pc.onicecandidate=WRTC.gotIceCandidate,WRTC.pc.onaddstream=WRTC.gotRemoteStream,WRTC.chat_datachannel=WRTC.pc.createDataChannel("chat",{negotiated:!0,id:0,ordered:!0}),WRTC.file_datachannel=WRTC.pc.createDataChannel("file",{negotiated:!0,id:1,ordered:!0}),WRTC.chat_datachannel.onopen=WRTC.chatDataChannelOnOpen,WRTC.chat_datachannel.onmessage=WRTC.chatDataChannelOnMessage,WRTC.file_datachannel.onopen=WRTC.fileDataChannelOnOpen,WRTC.file_datachannel.onmessage=WRTC.fileDataChannelOnMessage},attachStream:function(e,n){console.log("attachStream",n),window.URL||window.webkitURL?e.srcObject=n:e.src=n},gotStreamCalle:function(e){WRTC.attachStream(document.getElementById("localVideo"),e),WRTC.localStream=e,WRTC.pc=new PeerConnection(WRTC.pc_config),WRTC.addStreamToRTCPeerConnection(e),WRTC.pc.onicecandidate=WRTC.gotIceCandidate,WRTC.pc.onaddstream=WRTC.gotRemoteStream,WRTC.pc.ontrack=WRTC.gotRemoteTracks,WRTC.sendMessage({type:"offer_ready"}),WRTC.chat_datachannel=WRTC.pc.createDataChannel("chat",{negotiated:!0,id:0,ordered:!0}),WRTC.file_datachannel=WRTC.pc.createDataChannel("file",{negotiated:!0,id:1,ordered:!0}),WRTC.chat_datachannel.onopen=WRTC.chatDataChannelOnOpen,WRTC.chat_datachannel.onmessage=WRTC.chatDataChannelOnMessage,WRTC.file_datachannel.onopen=WRTC.fileDataChannelOnOpen,WRTC.file_datachannel.onmessage=WRTC.fileDataChannelOnMessage},createOffer:function(){console.log(Date.now(),"createOffer"),document.getElementById("hangupButton").style.display="inline-block",WRTC.pc.createOffer(WRTC.gotLocalDescription,function(e){console.log(e)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},createAnswer:function(){console.log(Date.now(),"createAnswer"),console.log(Date.now(),"signalingState",WRTC.pc.signalingState),WRTC.pc.createAnswer(WRTC.gotLocalDescription,function(e){console.log(e)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},gotLocalDescription:function(e){console.log(Date.now(),"gotLocalDescription:",e),WRTC.pc.setLocalDescription(e),WRTC.sendMessage(e)},gotIceCandidate:function(e){console.log(Date.now(),"gotIceCandidate: ",e.candidate),e.candidate&&WRTC.sendMessage({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate})},gotRemoteStream:function(e){console.log(Date.now(),"gotRemoteStream: ",e.stream),console.log(Date.now(),"gotRemoteStream(audio tracks): ",e.stream.getAudioTracks()),WRTC.attachStream(document.getElementById("remoteVideo"),e.stream),WRTC.online=!0,WRTC.app.au.stopSound(),WRTC.setHangUp(!0),document.getElementById("screenshareButton").style.display="inline-block",document.getElementById("videoOff").style.display="inline-block",document.getElementById("audioOff").style.display="inline-block"},gotRemoteTracks:function(e){console.log(Date.now(),"gotRemoteStream: ",e.streams),console.log(Date.now(),"gotRemoteStream(audio tracks): ",e.streams[0].getAudioTracks()),WRTC.attachStream(document.getElementById("remoteVideo"),e.streams[0]),WRTC.online=!0,WRTC.app.au.stopSound(),WRTC.setHangUp(!0),document.getElementById("screenshareButton").style.display="inline-block",document.getElementById("videoOff").style.display="inline-block",document.getElementById("audioOff").style.display="inline-block"},sendMessage:function(e,n){console.log(Date.now(),"send_message: ",e),void 0===n?WRTC.app.socket.send("wrtc_message",{message:e,to:WRTC.selected_user}):WRTC.app.socket.send("wrtc_message",{message:e,to:n})},hangup:function(){WRTC.sendMessage({type:"hangup"}),WRTC.disconnect(),WRTC.setHangUp(!1),document.getElementById("screenshareButton").style.display="none",document.getElementById("videoOff").style.display="none",document.getElementById("videoOn").style.display="none"},setHangUp:function(e){e?(WRTC.hang_up=!1,document.getElementById("hangupButton").style.display="inline-block",document.getElementById("callButton").style.display="none"):(WRTC.hang_up=!0,document.getElementById("hangupButton").style.display="none",document.getElementById("callButton").style.display="inline-block")},disconnect:function(){WRTC.hang_up=!0,WRTC.online&&(WRTC.online=!1),null!=WRTC.pc&&(WRTC.pc.close(),WRTC.pc=null),null!=WRTC.chat_datachannel&&(WRTC.chat_datachannel.close(),WRTC.chat_datachannel=null),null!=WRTC.file_datachannel&&(WRTC.file_datachannel.close(),WRTC.file_datachannel=null),null!=WRTC.localStream&&(WRTC.localStream.getVideoTracks().forEach(function(e){e.stop()}),WRTC.localStream.getAudioTracks().forEach(function(e){e.stop()}),WRTC.localStream=null),document.getElementById("localVideo").src="",document.getElementById("remoteVideo").src="",document.getElementById("screenshareButton").style.display="none",document.getElementById("videoOff").style.display="none",document.getElementById("videoOn").style.display="none",document.getElementById("audioOff").style.display="none",document.getElementById("audioOn").style.display="none",WRTC.app.au.stopSound(),WRTC.setSelectedUser(null)},gotMessage:function(n){var t=n.message,e=n.from;if(console.log(Date.now(),"recive_message: ",t),null!=WRTC.pc&&"offer"===t.type)WRTC.pc.setRemoteDescription(new SessionDescription(t)),WRTC.createAnswer();else if(null!=WRTC.pc&&"answer"===t.type)WRTC.pc.setRemoteDescription(new SessionDescription(t));else if(null!=WRTC.pc&&"candidate"===t.type){n=null;try{n=new IceCandidate(t),WRTC.pc.addIceCandidate(n)}catch(e){try{n=new IceCandidate({sdpMLineIndex:t.label,candidate:t.candidate}),WRTC.pc.addIceCandidate(n)}catch(e){console.log(e)}}}else"hangup"===t.type?(WRTC.disconnect(),closeDialogConfirm(),WRTC.setHangUp(!1)):"call"===t.type?WRTC.answer():"offer_ready"===t.type?WRTC.createOffer():"intent_call"===t.type?(WRTC.app.au.playSound(WRTC.app.iface.call_sound),dialogConfirm("Video chat",e+" calling You. <br/>Answer?",function(){WRTC.hangup(),WRTC.setSelectedUser(e),WRTC.sendMessage({type:"ready_call"})},function(){WRTC.sendMessage({type:"reject_call"},e),WRTC.app.au.stopSound()})):"ready_call"===t.type?WRTC.beginConnect():"reject_call"===t.type&&(WRTC.setSelectedUser(null),WRTC.app.au.stopSound(),WRTC.setHangUp(!1),dialogMessage("Video chat","Call was rejected"))},setSelectedUser:function(e){WRTC.selected_user=e,WRTC.app.iface.user_for_videochat.innerHTML=e,window.localStorage&&(null!==e?window.localStorage.setItem("videochat_user",e):window.localStorage.removeItem("videochat_user"))},screenShare:function(){navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia({video:!0}).then(function(e){WRTC.onGettingScreenSteam(e)},WRTC.getDisplayMediaError).catch(WRTC.getDisplayMediaError):navigator.getDisplayMedia&&navigator.getDisplayMedia({video:!0}).then(function(e){WRTC.onGettingScreenSteam(e)},getDisplayMediaError).catch(getDisplayMediaError):("Chrome"===DetectRTC.browser.name&&(71==DetectRTC.browser.version?dialogMessage('Please enable "Experimental WebPlatform" flag via chrome://flags.'):DetectRTC.browser.version<71?dialogMessage("Please upgrade your Chrome browser."):dialogMessage("Please make sure that you are not using Chrome on iOS.")),"Firefox"===DetectRTC.browser.name&&dialogMessage("Please upgrade your Firefox browser."),"Edge"===DetectRTC.browser.name&&dialogMessage("Please upgrade your Edge browser."),"Safari"===DetectRTC.browser.name&&dialogMessage("Safari does NOT supports getDisplayMedia API yet."))},getDisplayMediaError:function(e){"http:"===location.protocol?dialogMessage("Please test this WebRTC experiment on HTTPS."):(console.log(e),dialogMessage(e.toString()))},onGettingScreenSteam:function(e){WRTC.screenStream=e,WRTC.addStreamStopListener(e,WRTC.onScreenShareEnded),document.getElementById("screenshareButton").style.display="none",WRTC.removeStreamFromRTCPeerConnection(WRTC.localStream);e=WRTC.localStream.getAudioTracks();console.log("audio tracks",e),0<e.length&&(console.log("add audio track",e[0]),WRTC.screenStream.addTrack(e[0])),WRTC.addStreamToRTCPeerConnection(WRTC.screenStream),WRTC.createOffer()},addStreamStopListener:function(e,n){e.addEventListener("ended",function(){n(),n=function(){}},!1),e.addEventListener("inactive",function(){n(),n=function(){}},!1),e.getTracks().forEach(function(e){e.addEventListener("ended",function(){n(),n=function(){}},!1),e.addEventListener("inactive",function(){n(),n=function(){}},!1)})},onScreenShareEnded:function(){console.log("Screen share stopped"),document.getElementById("screenshareButton").style.display="inline-block",WRTC.removeStreamFromRTCPeerConnection(WRTC.screenStream),WRTC.addStreamToRTCPeerConnection(WRTC.localStream),WRTC.screenStream=null,WRTC.createOffer()},addStreamToRTCPeerConnection:function(n){try{WRTC.pc.addStream(n)}catch(e){n.getTracks().forEach(function(e){WRTC.pc.addTrack(e,n)})}},removeStreamFromRTCPeerConnection:function(t){try{WRTC.pc.removeStream(t)}catch(e){WRTC.pc.getSenders().forEach(function(n){t.getTracks().forEach(function(e){e==n.track&&WRTC.pc.removeTrack(n)})})}},videoOff:function(){WRTC.localStream.getVideoTracks().forEach(function(e){e.enabled=!1}),document.getElementById("videoOn").style.display="inline-block",document.getElementById("videoOff").style.display="none",WRTC.createOffer()},videoOn:function(){WRTC.localStream.getVideoTracks().forEach(function(e){e.enabled=!0}),document.getElementById("videoOff").style.display="inline-block",document.getElementById("videoOn").style.display="none",WRTC.createOffer()},audioOff:function(){WRTC.localStream.getAudioTracks().forEach(function(e){e.enabled=!1}),document.getElementById("audioOn").style.display="inline-block",document.getElementById("audioOff").style.display="none",WRTC.createOffer()},audioOn:function(){WRTC.localStream.getAudioTracks().forEach(function(e){e.enabled=!0}),document.getElementById("audioOff").style.display="inline-block",document.getElementById("audioOn").style.display="none",WRTC.createOffer()},chatDataChannelOnOpen:function(e){WRTC.chat_datachannel.send(["Hi ",WRTC.selected_user,"!"].join(" "))},chatDataChannelOnMessage:function(e){e={created:(new Date).getTime(),from:WRTC.selected_user,to:WRTC.app.nicname,message:e.data};console.log(e),WRTC.app.iface.addMessage(e)},fileDataChannelOnOpen:function(e){console.log("file datachannel open")},fileDataChannelOnMessage:function(e){"string"==typeof e.data?WRTC.app.filesp2p.startDownload(e.data):WRTC.app.filesp2p.progressDownload(e.data)}};!function(){var e="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";(m="object"==typeof process&&"object"==typeof process.versions&&process.versions.node&&!process.browser)&&(o=process.versions.node.toString().replace("v",""),e="Nodejs/"+o+" (NodeOS) AppleWebKit/"+o+" (KHTML, like Gecko) Nodejs/"+o+" Nodejs/"+o),s="undefined"!=typeof global?global:window,"undefined"==typeof window&&("undefined"==typeof window&&"undefined"!=typeof global&&(global.navigator={userAgent:e,getUserMedia:function(){}},s.window=global),"undefined"==typeof location&&(s.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(s.screen={width:0,height:0}));var r=window.navigator;void 0!==r?(void 0!==r.webkitGetUserMedia&&(r.getUserMedia=r.webkitGetUserMedia),void 0!==r.mozGetUserMedia&&(r.getUserMedia=r.mozGetUserMedia)):r={getUserMedia:function(){},userAgent:e};var n=!!/Android|webOS|iPhone|iPad|iPod|BB10|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(r.userAgent||""),a=!(-1===r.userAgent.indexOf("Edge")||!r.msSaveOrOpenBlob&&!r.msSaveBlob),c=!!window.opera||0<=r.userAgent.indexOf(" OPR/"),l=-1<r.userAgent.toLowerCase().indexOf("firefox")&&"netscape"in window&&/ rv:/.test(r.userAgent),d=/^((?!chrome|android).)*safari/i.test(r.userAgent),u=!!window.chrome&&!c,p="undefined"!=typeof document&&!!document.documentMode&&!a;function i(e,n){var t=0,o=!1,i=window.setInterval(function(){e()&&(window.clearInterval(i),n(o)),50<t++&&(window.clearInterval(i),n(o=!0))},10)}var t={Android:function(){return r.userAgent.match(/Android/i)},BlackBerry:function(){return r.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return r.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return r.userAgent.match(/Opera Mini/i)},Windows:function(){return r.userAgent.match(/IEMobile/i)},any:function(){return t.Android()||t.BlackBerry()||t.iOS()||t.Opera()||t.Windows()},getOsName:function(){var e="Unknown OS";return t.Android()&&(e="Android"),t.BlackBerry()&&(e="BlackBerry"),t.iOS()&&(e="iOS"),t.Opera()&&(e="Opera Mini"),e=t.Windows()?"Windows":e}};var o="Unknown OS",s="Unknown OS Version";var f,e=function(){for(var e,n=r.appVersion,t=r.userAgent,o="-",i=[{s:"Chrome OS",r:/CrOS/},{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],s=0;e=i[s];s++)if(e.r.test(t)){o=e.s;break}var a="-";switch(/Windows/.test(o)&&(/Windows (.*)/.test(o)&&(a=/Windows (.*)/.exec(o)[1]),o="Windows"),o){case"Mac OS X":/Mac OS X (10[\.\_\d]+)/.test(t)&&(a=/Mac OS X (10[\.\_\d]+)/.exec(t)[1]);break;case"Android":/Android ([\.\_\d]+)/.test(t)&&(a=/Android ([\.\_\d]+)/.exec(t)[1]);break;case"iOS":/OS (\d+)_(\d+)_?(\d+)?/.test(t)&&(a=(a=/OS (\d+)_(\d+)_?(\d+)?/.exec(n))[1]+"."+a[2]+"."+(0|a[3]))}return{osName:o,osVersion:a}}();e&&e.osName&&"-"!=e.osName?(o=e.osName,s=e.osVersion):t.any()&&"Android"==(o=t.getOsName())&&(s=!!(f=(f=(f||r.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/))&&f[1]);var m="object"==typeof process&&"object"==typeof process.versions&&process.versions.node;"Unknown OS"===o&&m&&(o="Nodejs",s=process.versions.node.toString().replace("v",""));var g=!1,h=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(e){"undefined"!=typeof document&&"function"==typeof document.createElement&&(!g&&e in document.createElement("canvas")&&(g=!0),!h&&e in document.createElement("video")&&(h=!0))});var w=/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/,C=/([0-9]{1,3}(\.[0-9]{1,3}){3})/,v=/[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7}/;var T=[],S=[],y=[],b=[];r.mediaDevices&&r.mediaDevices.enumerateDevices&&(r.enumerateDevices=function(e){var n=r.mediaDevices.enumerateDevices();n&&n.then?r.mediaDevices.enumerateDevices().then(e).catch(function(){e([])}):e([])});var k=!1;("undefined"!=typeof MediaStreamTrack&&"getSources"in MediaStreamTrack||r.mediaDevices&&r.mediaDevices.enumerateDevices)&&(k=!0);var R=!1,I=!1,_=!1,W=!1,A=!1;function M(n){var o;k?(!r.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(r.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!r.enumerateDevices&&r.enumerateDevices&&(r.enumerateDevices=r.enumerateDevices.bind(r)),r.enumerateDevices?(T=[],S=[],y=[],A=W=_=I=R=!(b=[]),o={},r.enumerateDevices(function(e){e.forEach(function(e){var n,t={};for(n in e)try{"function"!=typeof e[n]&&(t[n]=e[n])}catch(e){}o[t.deviceId+t.label+t.kind]||("audio"===t.kind&&(t.kind="audioinput"),"video"===t.kind&&(t.kind="videoinput"),t.deviceId||(t.deviceId=t.id),t.id||(t.id=t.deviceId),t.label?("videoinput"!==t.kind||A||(A=!0),"audioinput"!==t.kind||W||(W=!0)):(t.isCustomLabel=!0,"videoinput"===t.kind?t.label="Camera "+(b.length+1):"audioinput"===t.kind?t.label="Microphone "+(S.length+1):"audiooutput"===t.kind?t.label="Speaker "+(y.length+1):t.label="Please invoke getUserMedia once.",void 0!==E&&E.browser.isChrome&&46<=E.browser.version&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(t.label="HTTPs is required to get label of this "+t.kind+" device.")),"audioinput"===t.kind&&(R=!0,-1===S.indexOf(t)&&S.push(t)),"audiooutput"===t.kind&&(I=!0,-1===y.indexOf(t)&&y.push(t)),"videoinput"===t.kind&&(_=!0,-1===b.indexOf(t)&&b.push(t)),T.push(t),o[t.deviceId+t.label+t.kind]=t)}),void 0!==E&&(E.MediaDevices=T,E.hasMicrophone=R,E.hasSpeakers=I,E.hasWebcam=_,E.isWebsiteHasWebcamPermissions=A,E.isWebsiteHasMicrophonePermissions=W,E.audioInputDevices=S,E.audioOutputDevices=y,E.videoInputDevices=b),n&&n()})):n&&n()):n&&n()}var E=window.DetectRTC||{};E.browser=function(){r.appVersion;var e,n,t=r.userAgent,o=r.appName,i=""+parseFloat(r.appVersion),s=parseInt(r.appVersion,10);if(c){o="Opera";try{s=(i=r.userAgent.split("OPR/")[1].split(" ")[0]).split(".")[0]}catch(e){i="0.0.0.0",s=0}}else p?(i=0<(n=t.indexOf("rv:"))?t.substring(n+3):(n=t.indexOf("MSIE"),t.substring(n+5)),o="IE"):u?(n=t.indexOf("Chrome"),o="Chrome",i=t.substring(n+7)):d?-1!==t.indexOf("CriOS")?(n=t.indexOf("CriOS"),o="Chrome",i=t.substring(n+6)):-1!==t.indexOf("FxiOS")?(n=t.indexOf("FxiOS"),o="Firefox",i=t.substring(n+6)):(n=t.indexOf("Safari"),o="Safari",i=t.substring(n+7),-1!==(n=t.indexOf("Version"))&&(i=t.substring(n+8)),-1!==r.userAgent.indexOf("Version/")&&(i=r.userAgent.split("Version/")[1].split(" ")[0])):l?(n=t.indexOf("Firefox"),o="Firefox",i=t.substring(n+8)):(e=t.lastIndexOf(" ")+1)<(n=t.lastIndexOf("/"))&&(o=t.substring(e,n),i=t.substring(n+1),o.toLowerCase()===o.toUpperCase()&&(o=r.appName));return a&&(o="Edge",i=r.userAgent.split("Edge/")[1]),-1!==(n=i.search(/[; \)]/))&&(i=i.substring(0,n)),s=parseInt(""+i,10),isNaN(s)&&(i=""+parseFloat(r.appVersion),s=parseInt(r.appVersion,10)),{fullVersion:i,version:s,name:o,isPrivateBrowsing:!1}}(),function(n){var t,o;try{if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,function(){t=!1},function(e){t=!0});else if(window.indexedDB&&/Firefox/.test(window.navigator.userAgent)){try{(o=window.indexedDB.open("test")).onerror=function(){return!0}}catch(e){t=!0}void 0===t&&i(function(){return"done"===o.readyState},function(e){e||(t=!o.result)})}else if(function(e){if(0!==(e=e.toLowerCase()).indexOf("msie")||0!==e.indexOf("trident")){e=/(?:msie|rv:)\s?([\d\.]+)/.exec(e);return!!(e&&10<=parseInt(e[1],10))}}(window.navigator.userAgent)){t=!1;try{window.indexedDB||(t=!0)}catch(e){t=!0}}else if(window.localStorage&&/Safari/.test(window.navigator.userAgent)){try{window.localStorage.setItem("test",1)}catch(e){t=!0}void 0===t&&(t=!1,window.localStorage.removeItem("test"))}}catch(e){t=!1}i(function(){return void 0!==t},function(e){n(t)})}(function(e){E.browser.isPrivateBrowsing=!!e}),E.browser["is"+E.browser.name]=!0,E.osName=o,E.osVersion=s;"object"==typeof process&&"object"==typeof process.versions&&process.versions["node-webkit"];var F=!1;["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(e){F||e in window&&(F=!0)}),E.isWebRTCSupported=F,E.isORTCSupported="undefined"!=typeof RTCIceGatherer;s=!1;(E.browser.isChrome&&35<=E.browser.version||E.browser.isFirefox&&34<=E.browser.version||E.browser.isEdge&&17<=E.browser.version||"Android"===E.osName&&E.browser.isChrome)&&(s=!0),(r.getDisplayMedia||r.mediaDevices&&r.mediaDevices.getDisplayMedia)&&(s=!0),/^(https:|chrome-extension:)$/g.test(location.protocol||"")||("undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(E.browser.isChrome||E.browser.isEdge||E.browser.isOpera)||E.browser.isFirefox)&&(s=!1),E.isScreenCapturingSupported=s;var O={isSupported:!1,isCreateMediaStreamSourceSupported:!1};["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"].forEach(function(e){O.isSupported||e in window&&(O.isSupported=!0,window[e]&&"createMediaStreamSource"in window[e].prototype&&(O.isCreateMediaStreamSourceSupported=!0))}),E.isAudioContextSupported=O.isSupported,E.isCreateMediaStreamSourceSupported=O.isCreateMediaStreamSourceSupported;s=!1;E.browser.isChrome&&31<E.browser.version&&(s=!0),E.isRtpDataChannelsSupported=s;s=!1;(E.browser.isFirefox&&28<E.browser.version||E.browser.isChrome&&25<E.browser.version||E.browser.isOpera&&11<=E.browser.version)&&(s=!0),E.isSctpDataChannelsSupported=s,E.isMobileDevice=n;n=!1;(r.getUserMedia||r.mediaDevices&&r.mediaDevices.getUserMedia)&&(n=!0),E.browser.isChrome&&46<=E.browser.version&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(n="Requires HTTPs"),"Nodejs"===E.osName&&(n=!1),E.isGetUserMediaSupported=n;var x,D,U,n="";screen.width&&(n+=(screen.width||"")+" x "+(screen.height||"")),E.displayResolution=n,E.displayAspectRatio=(x=screen.width,D=screen.height,U=function e(n,t){return 0==t?n:e(t,n%t)}(x,D),(x/U/(D/U)).toFixed(2)),E.isCanvasSupportsStreamCapturing=g,E.isVideoSupportsStreamCapturing=h,"Chrome"==E.browser.name&&53<=E.browser.version&&(E.isCanvasSupportsStreamCapturing||(E.isCanvasSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features"),E.isVideoSupportsStreamCapturing||(E.isVideoSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features")),E.DetectLocalIPAddress=function(n,e){var t,o;E.isWebRTCSupported&&(o=t=!0,function(t,e){if("undefined"!=typeof document&&"function"==typeof document.getElementById){var o={},n=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;if(!n){var i=document.getElementById("iframe");if(!i)return;i=i.contentWindow;n=i.RTCPeerConnection||i.mozRTCPeerConnection||i.webkitRTCPeerConnection}if(n){i=null;"Chrome"===E.browser&&E.browser.version<58&&(i={optional:[{RtpDataChannels:!0}]});var s=new n({iceServers:[{urls:"stun:stun.l.google.com:19302"}]},i);if(e&&(s.addStream?s.addStream(e):s.addTrack&&e.getTracks()[0]&&s.addTrack(e.getTracks()[0],e)),s.onicecandidate=function(e){e.candidate&&e.candidate.candidate?a(e.candidate.candidate):a()},!e)try{s.createDataChannel("sctp",{})}catch(e){}E.isPromisesSupported?s.createOffer().then(function(e){s.setLocalDescription(e).then(r)}):s.createOffer(function(e){s.setLocalDescription(e,r,function(){})},function(){})}}function a(e){var n;e?(n=C.exec(e))&&(n=n[1],e=e.match(w),void 0===o[n]&&t(n,e,!0),o[n]=!0):t()}function r(){s.localDescription.sdp.split("\n").forEach(function(e){e&&0===e.indexOf("a=candidate:")&&a(e)})}}(function(e){e?e.match(w)?n("Local: "+e,t=!1,o):e.match(v)?n("Public: "+e,t,o=!1):n("Public: "+e,t,o):n()},e))},E.isWebSocketsSupported="WebSocket"in window&&2===window.WebSocket.CLOSING,E.isWebSocketsBlocked=!E.isWebSocketsSupported,"Nodejs"===E.osName&&(E.isWebSocketsSupported=!0,E.isWebSocketsBlocked=!1),E.checkWebSocketsSupport=function(n){n=n||function(){};try{var e,t=new WebSocket("wss://echo.websocket.org:443/");t.onopen=function(){E.isWebSocketsBlocked=!1,e=(new Date).getTime(),t.send("ping")},t.onmessage=function(){E.WebsocketLatency=(new Date).getTime()-e+"ms",n(),t.close(),t=null},t.onerror=function(){E.isWebSocketsBlocked=!0,n()}}catch(e){E.isWebSocketsBlocked=!0,n()}},E.load=function(e){M(e=e||function(){})},E.MediaDevices=void 0!==T?T:[],E.hasMicrophone=R,E.hasSpeakers=I,E.hasWebcam=_,E.isWebsiteHasWebcamPermissions=A,E.isWebsiteHasMicrophonePermissions=W,E.audioInputDevices=S,E.audioOutputDevices=y,E.videoInputDevices=b;n=!1;"undefined"!=typeof document&&"function"==typeof document.createElement&&"setSinkId"in document.createElement("video")&&(n=!0),E.isSetSinkIdSupported=n;n=!1;E.browser.isFirefox&&"undefined"!=typeof mozRTCPeerConnection?"getSenders"in mozRTCPeerConnection.prototype&&(n=!0):E.browser.isChrome&&"undefined"!=typeof webkitRTCPeerConnection&&"getSenders"in webkitRTCPeerConnection.prototype&&(n=!0),E.isRTPSenderReplaceTracksSupported=n;n=!1;E.browser.isFirefox&&38<E.browser.version&&(n=!0),E.isRemoteStreamProcessingSupported=n;n=!1;"undefined"!=typeof MediaStreamTrack&&"applyConstraints"in MediaStreamTrack.prototype&&(n=!0),E.isApplyConstraintsSupported=n;n=!1;E.browser.isFirefox&&43<=E.browser.version&&(n=!0),E.isMultiMonitorScreenCapturingSupported=n,E.isPromisesSupported=!!("Promise"in window),E.version="1.3.9",void 0===E&&(window.DetectRTC={});n=window.MediaStream;void 0===n&&"undefined"!=typeof webkitMediaStream&&(n=webkitMediaStream),E.MediaStream=void 0!==n&&"function"==typeof n&&Object.keys(n.prototype),"undefined"!=typeof MediaStreamTrack?E.MediaStreamTrack=Object.keys(MediaStreamTrack.prototype):E.MediaStreamTrack=!1;n=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;E.RTCPeerConnection=void 0!==n&&Object.keys(n.prototype),window.DetectRTC=E,"undefined"!=typeof module&&(module.exports=E),"function"==typeof define&&define.amd&&define("DetectRTC",[],function(){return E})}();